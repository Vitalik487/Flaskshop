{% extends "layout.html" %} {% block page_title %} View Order {% endblock %} {% block content_class %}
    orders-show-page{% endblock content_class %} {% block content %}

    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>Order Detail</h4>
                </div>
                <div class="panel-body">
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Product Detail</th>
                            <th class="text-center">Unit Price</th>
                            <th class="text-center">Quantity</th>
                            <th class="text-right item-amount">Subtotal</th>
                        </tr>
                        </thead>
                        {% for item in order.items %}
                            <tr>
                                <td class="product-info">
                                    <div class="preview">
                                        <a target="_blank" href="{{ url_for('product.show', id=item.product_id) }}">
                                            <img src="{{ item.product.image }}">
                                        </a>
                                    </div>
                                    <div>
                                <span class="product-title">
                                    <a target="_blank"
                                       href="{{ url_for('product.show', id=item.product_id) }}">{{ item.product.title }}</a>
                                </span>
                                        <span class="sku-title">{{ item.product_sku.title }}</span>
                                    </div>
                                </td>
                                <td class="sku-price text-center vertical-middle">${{ item.price }}</td>
                                <td class="sku-amount text-center vertical-middle">{{ item.amount }}</td>
                                <td class="item-amount text-right vertical-middle">
                                    ${{ item.price * item.amount }}</td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <td colspan="4"></td>
                        </tr>
                    </table>
                    <div class="order-bottom">
                        <div class="order-info">
                            <div class="line">
                                <div class="line-label">Address：</div>
                                <div class="line-value">{{ order.address }}</div>
                            </div>
                            <div class="line">
                                <div class="line-label">Remark：</div>
                                <div class="line-value">{{ order.remark }}</div>
                            </div>
                            <div class="line">
                                <div class="line-label">Order No.：</div>
                                <div class="line-value">{{ order.no }}</div>
                            </div>
                            <!-- 输出物流状态 -->
                            <div class="line">
                                <div class="line-label">ShipStatus：</div>
                                <div class="line-value">
                                    {{ order.ship_status }}</div>
                            </div>
                            <!-- 如果有物流信息则展示 -->
                            {% if order.ship_data %}
                                <div class="line">
                                    <div class="line-label">物流信息：</div>
                                    <div class="line-value">{{ order.ship_data['express_company'] }} {{ order.ship_data['express_no'] }}</div>
                                </div>
                            {% endif %}
                            <!-- 订单已支付，且退款状态不是未退款时展示退款信息 -->
                            {% if order.paid_at and not order.refund_status == 'pending' %}

                                <div class="line">
                                    <div class="line-label">退款状态：</div>
                                    <div class="line-value">
                                        {{ order.refund_status }}</div>
                                </div>
                                <div class="line">
                                    <div class="line-label">退款理由：</div>
                                    <div class="line-value">{{ order.extra['refund_reason'] }}</div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="order-summary text-right">
                            {% if order.coupon_code %}

                                <div class="text-primary">
                                    <span>Discount：</span>
                                    <div class="value">{{ order.coupon_code.description }}</div>
                                </div>
                            {% endif %}
                            <div class="total-amount">
                                <span>Total Amount：</span>
                                <div class="value">${{ order.total_amount }}</div>
                            </div>
                            <div>
                                <span>Order state：</span>
                                <div class="value">
                                    Process
                                </div>
                            </div>

                            {% if order.extra and 'refund_disagree_reason' in order.extra %}
                                <div>
                                    <span>拒绝退款理由：</span>
                                    <div class="value">{{ order.extra['refund_disagree_reason'] }}</div>
                                </div>
                            {% endif %}
                            <!-- 支付按钮开始 -->
                            {% if not order.paid_at and not order.closed %}

                                <div class="payment-buttons">
                                    <a class="btn btn-primary btn-sm"
                                       href="{{ url_for('order.ali_pay', id=order.id) }}">支付宝支付</a>
                                    <button class="btn btn-sm btn-success" id='btn-wechat'>微信支付</button>
                                </div>
                            {% endif %}
                            <!-- 支付按钮结束 -->
                            <!-- 如果订单的发货状态为已发货则展示确认收货按钮 -->
                            {% if order.ship_status == 'delivered' %}
                                <div class="receive-button">
                                    <button type="button" id="btn-receive" class="btn btn-sm btn-success">确认收货</button>
                                </div>
                            {% endif %}
                            <!-- 订单已支付，且退款状态是未退款时展示申请退款按钮 -->
                            {% if order.paid_at and order.refund_status == 'pending' %}

                                <div class="refund-button">
                                    <button class="btn btn-sm btn-danger" id="btn-apply-refund">Request A Refound
                                    </button>
                                </div>

                            {% endif %}
                            {% if order.paid_at %}
                                <div class="refund-button">
                                    <a class="btn btn-success btn-sm" href="{{ url_for('order.review', id=order.id) }}">
                                        {{ 'Review detail' if order.reviewed else 'Review' }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block js %}
    <script>
        $(document).ready(function () {
            // 微信支付按钮事件
            $('#btn-wechat').click(function () {
                swal({
                    // content 参数可以是一个 DOM 元素，这里我们用 jQuery 动态生成一个 img 标签，并通过 [0] 的方式获取到 DOM 元素
                    content: $('')[0],
                    // buttons 参数可以设置按钮显示的文案
                    buttons: ['关闭', '已完成付款'],
                })
                    .then(function (result) {
                        // 如果用户点击了 已完成付款 按钮，则重新加载页面
                        if (result) {
                            location.reload();
                        }
                    })
            });
            // 确认收货按钮点击事件
            $('#btn-receive').click(function () {
                // 弹出确认框
                swal({
                    title: "确认已经收到商品？",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                    buttons: ['取消', '确认收到'],
                })
                    .then(function (ret) {
                        // 如果点击取消按钮则不做任何操作
                        if (!ret) {
                            return;
                        }
                        // ajax 提交确认操作
                        axios.post("{{ url_for('order.received', id=order.id) }}")
                            .then(function () {
                                // 刷新页面
                                location.reload();
                            })
                    });
            });
            // 退款按钮点击事件
            $('#btn-apply-refund').click(function () {
                swal({
                    text: '请输入退款理由',
                    content: "input",
                }).then(function (input) {
                    // 当用户点击 swal 弹出框上的按钮时触发这个函数
                    if (!input) {
                        swal('退款理由不可空', '', 'error');
                        return;
                    }
                    // 请求退款接口
                    axios.post("{{ url_for('order.request_refund', id=order.id) }}", {reason: input})
                        .then(function () {
                            swal('申请退款成功', '', 'success').then(function () {
                                // 用户点击弹框上按钮时重新加载页面
                                location.reload();
                            });
                        });
                });
            });
        });
    </script>
{% endblock %}